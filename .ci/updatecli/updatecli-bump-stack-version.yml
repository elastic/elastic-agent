# update-cli configuration for automated go updates
---
name: Bump .stable-snapshot-version

scms:
  githubConfig:
    kind: github
    spec:
      user: '{{ requiredEnv "GITHUB_ACTOR" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      owner: "{{ .scm.owner }}"
      repository: "{{ .scm.repository }}"
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      branch: '{{ requiredEnv "BRANCH_NAME" }}'
      commitusingapi: true

sources:
  lastStableStackSnapshot:
    name: "Latest Stable ESS snapshot for current branch"
    kind: json
    spec:
      file: 'https://storage.googleapis.com/artifacts-api/channels/{{ requiredEnv "BRANCH_NAME" }}.json'
      key: "build"
targets:
  updateStableSnapshotFile:
    name: "Update .stable-snapshot-version"
    sourceid: lastStableStackSnapshot
    scmid: githubConfig
    kind: file
    spec:
      file: "test_infra/ess/.stable-snapshot-version"
      content: '{{ source "lastStableStackSnapshot" }}-SNAPSHOT'
actions:
  elastic-agent:
    kind: github/pullrequest
    scmid: githubConfig
    sourceid: lastStableStackSnapshot
    spec:
      automerge: false
      labels:
        - dependencies
        - backport-skip
        - skip-changelog
      title: '[{{ requiredEnv "BRANCH_NAME" }}][Automation] Bump .stable-snapshot-version version to {{ source "lastStableStackSnapshot" }}'
      description: |
        ### What does this PR do
        Updates `.stable-snapshot-version`. 
        It is used to pin stable stack version for integration tests.

        ### How it works
        The version: `{{ source "lastStableStackSnapshot" }}` is taken from 'https://storage.googleapis.com/artifacts-api/channels/{{ requiredEnv "BRANCH_NAME" }}.json'
        These PRs are automatically created when a new stable/tested SNAPSHOT version is available for this branch.
