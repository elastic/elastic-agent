# update-cli configuration for automated VM image version bumping
---
name: Bump vm-images to latest version
pipelineid: 'updatecli-update-vm-images-{{ requiredEnv "BRANCH_NAME" }}'

scms:
  githubConfig:
    kind: github
    spec:
      user: '{{ requiredEnv "GITHUB_ACTOR" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      owner: '{{ .scm.owner }}'
      repository: '{{ .scm.repository }}'
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      branch: '{{ requiredEnv "BRANCH_NAME" }}'
      directory: '{{ requiredEnv "GITHUB_WORKSPACE" }}'
      force: false

actions:
  elastic-agent:
    kind: shell
    spec:
      command: |
        git config user.name "{{ requiredEnv "GITHUB_ACTOR" }}"
        git config user.email "{{ requiredEnv "GITHUB_ACTOR" }}@users.noreply.github.com"
        git add -A
        git commit -m "[{{ requiredEnv "BRANCH_NAME" }}][Automation] Bump VM Image version to {{ source "latestVersion" }}" || echo "No changes to commit"
        git push origin HEAD
        gh pr create --fill --label dependencies --label backport-skip --label skip-changelog --title '[{{ requiredEnv "BRANCH_NAME" }}][Automation] Bump VM Image version to {{ source "latestVersion" }}' || gh pr edit --add-label dependencies --add-label backport-skip --add-label skip-changelog || echo "PR creation skipped"
      environments:
        - name: PATH
        - name: GITHUB_TOKEN
        - name: GH_TOKEN
          value: '{{ requiredEnv "GITHUB_TOKEN" }}'

sources:
  latestVersion:
    name: Get latest available build
    kind: json
    spec:
      file: https://storage.googleapis.com/artifacts-api/vm-images/elastic-agent/latest.json
      key: .date

conditions:
  latestVersion-check:
    name: Check if defined latest version differs
    kind: file
    sourceid: latestVersion
    spec:
      file: .buildkite/pipeline.yml
      matchpattern: 'platform-ingest-elastic-agent-(.+)-{{ source "latestVersion" }}'
    failwhen: true

# NOTE: if you add a new target file, please update the .mergify.yml file
#       to include the new file for the approval and automatic merge
targets:
  update-buildkite-pipeline:
    name: "Update .buildkite/pipeline.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/pipeline.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'

  update-buildkite-bk.integration.pipeline:
    name: "Update .buildkite/bk.integration.pipeline.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/bk.integration.pipeline.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'

  update-integration.pipeline:
    name: "Update .buildkite/integration.pipeline.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/integration.pipeline.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'

  update-buildkite-bk.integration-fips.pipeline:
    name: "Update .buildkite/bk.integration-fips.pipeline.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/bk.integration-fips.pipeline.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'

  update-buildkite-pipeline.elastic-agent-binary-dra:
    name: "Update .buildkite/pipeline.elastic-agent-binary-dra.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/pipeline.elastic-agent-binary-dra.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'

  update-buildkite-pipeline.elastic-agent-package:
    name: "Update .buildkite/pipeline.elastic-agent-package.yml"
    sourceid: latestVersion
    kind: file
    spec:
      file: .buildkite/pipeline.elastic-agent-package.yml
      matchpattern: '(IMAGE_.+): "platform-ingest-elastic-agent-(.+)-(.+)"'
      replacepattern: '$1: "platform-ingest-elastic-agent-$2-{{ source "latestVersion" }}"'
