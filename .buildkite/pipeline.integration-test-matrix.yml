# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  DOCKER_REGISTRY: "docker.elastic.co"

# This section is used to define the plugins that will be used in the pipeline.
# See https://buildkite.com/docs/pipelines/integrations/plugins/using#using-yaml-anchors-with-plugins
common:
  - google_oidc_plugin: &google_oidc_plugin
      # See https://github.com/elastic/oblt-infra/blob/main/conf/resources/repos/elastic-agent/01-gcp-oidc.tf
      # This plugin authenticates to Google Cloud using the OIDC token.
      elastic/oblt-google-auth#v1.2.0:
        lifetime: 10800 # seconds
        project-id: "elastic-observability-ci"
        project-number: "911195782929"

steps:
  - label: "Integration tests: packaging"
    key: "package-it"
    command: ".buildkite/scripts/steps/integration-package.sh"
    artifact_paths:
      - build/distributions/**
    agents:
      provider: "gcp"
      machineType: "n1-standard-8"

  - label: "Integration test matrix"
    key: "integration-tests-matrix"
    depends_on: "package-it"
    command: |
      echo "~~~ Downloading artifacts"
      buildkite-agent artifact download build/distributions/** . --step 'package-it'
      .buildkite/scripts/steps/integration_tests.sh stateful integration:matrix
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
    agents:
      provider: "gcp"
      machineType: "n1-standard-8"
    plugins:
      - *google_oidc_plugin
