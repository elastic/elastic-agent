env:
  VERSION: "${BUILDKITE_COMMIT:0:12}"

# This section is used to define the plugins that will be used in the pipeline.
# See https://buildkite.com/docs/pipelines/integrations/plugins/using#using-yaml-anchors-with-plugins
common:
  - docker_login_plugin: &docker_login_plugin
      elastic/vault-docker-login#v0.5.2:
        secret_path: 'kv/ci-shared/platform-ingest/elastic_docker_registry'

steps:
  - label: "Packaging: Service Container linux/amd64"
    key: packaging-service-container-amd64
    env:
      PACKAGES: "docker"
      PLATFORMS: "linux/amd64"
      DOCKER_VARIANTS: "service"
    command: |
      .buildkite/scripts/steps/integration-package.sh
    artifact_paths:
      - "build/distributions/elastic-agent-service-git-*.docker.tar.gz"
    agents:
      provider: "gcp"
      machineType: "c2-standard-16"
      diskSizeGb: 400

  - label: "Packaging: Service Container linux/arm64"
    key: packaging-service-container-arm64
    env:
      PACKAGES: "docker"
      PLATFORMS: "linux/arm64"
      DOCKER_VARIANTS: "service"
    command: |
       .buildkite/scripts/steps/integration-package.sh
    artifact_paths:
      - "build/distributions/elastic-agent-service-git-*.docker.tar.gz"
    agents:
      provider: "aws"
      instanceType: "t4g.2xlarge"
      imagePrefix: "core-ubuntu-2204-aarch64"
      diskSizeGb: 400

  # wait for packaging to be done
  - wait: ~

  - label: "Publish to internal registry"
    key: "mirror-elastic-agent"
    command: ".buildkite/scripts/steps/ecp-internal-release.sh"
    agents:
      provider: "gcp"
      machineType: "c2-standard-16"
    plugins:
      - *docker_login_plugin

  # wait for metadata to be set
  - wait: ~

  - label: ":docker: Validate docker image is built for all architectures"
    command: ".buildkite/scripts/steps/validate-agentless-docker-image.sh"
    env:
      SERVICE_VERSION: "${VERSION}"
    agents:
      image: "docker.elastic.co/ci-agent-images/observability/oci-image-tools-agent:latest@sha256:a4ababd1347111759babc05c9ad5a680f4af48892784951358488b7e7fc94af9"
    plugins:
      - elastic/vault-docker-login#v0.6.3:
          secret_path: 'kv/ci-shared/platform-ingest/elastic_docker_registry'

  # wait for image architecture validation
  - wait: ~

  - label: ":grey_question: Promote agentless app release if validation passes"
    # DRY_RUN will help to skip this step when set to true
    if: build.env("DRY_RUN") == null || build.env("DRY_RUN") == "false"
    depends_on: "mirror-elastic-agent"
    command: |
      export COMMIT_HASH=$$(buildkite-agent meta-data get git-short-commit)
      if [ $$(buildkite-agent step get "outcome" --step "mirror-elastic-agent") == "passed" ]; then
          cat <<- YAML | buildkite-agent pipeline upload
          steps:
          - label: ":serverless::argo: Run synthetics tests and update agentless to $${COMMIT_HASH} in serverless-gitops"
            async: true
            branches: main
            trigger: gpctl-promote-after-serverless-devenv-synthetics
            build:
              env:
                SERVICE_COMMIT_HASH: $${COMMIT_HASH}
                SERVICE: agentless
                SYNTHETICS_PROJECT: "agentless"
                SYNTHETICS_TAG: "agentless-ci"
      YAML
      fi
    agents:
      image: docker.elastic.co/ci-agent-images/serverless-helm-builder:0.0.2@sha256:d00e8a7a0ab3618cfaacb0a7b1e1b06ee29728eb2b44de602374bd8f6b9b92ac
