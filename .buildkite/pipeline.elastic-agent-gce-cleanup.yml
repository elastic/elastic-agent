# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

# Removes stale GCE instances having matching labels, name prefixes and older than 24 hours
# See gce-cleanup.sh and .buildkite/misc/gce-cleanup.yml
env:
  DOCKER_REGISTRY: "docker.elastic.co"

# This section is used to define the plugins that will be used in the pipeline.
# See https://buildkite.com/docs/pipelines/integrations/plugins/using#using-yaml-anchors-with-plugins
common:
  - google_oidc_plugin: &google_oidc_plugin
      # See https://github.com/elastic/oblt-infra/blob/main/conf/resources/repos/elastic-agent/01-gcp-oidc.tf
      # This plugin authenticates to Google Cloud using the OIDC token.
      elastic/oblt-google-auth#v1.2.0:
        lifetime: 10800 # seconds
        project-id: "elastic-observability-ci"
        project-number: "911195782929"

steps:
  - label: "GCE Cleanup"
    key: "gce-cleanup"
    command: ".buildkite/scripts/steps/gce-cleanup.sh"
    agents:
      provider: "gcp"
    plugins:
      - *google_oidc_plugin
