# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  DOCKER_REGISTRY: "docker.elastic.co"
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"
  ASDF_MAGE_VERSION: 1.14.0
  ASDF_GOLANG_VERSION: 1.22.6
  ASDF_TERRAFORM_VERSION: 1.9.2

  AWS_ARM_INSTANCE_TYPE: "m6g.xlarge"
  AWS_IMAGE_UBUNTU_ARM_64: test-platform-ingest-elastic-agent-ubuntu-2204-aarch64

steps:
  - group: "Stateful IT (Sudo): Ubuntu"
    key: integration-tests-ubuntu
    steps:
      - label: "{{matrix}}"
        command: |
          TEST_GROUP={{matrix}} TEST_SUDO=true mage -v integration:gettests
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n1-standard-8"
          image: "family/platform-ingest-elastic-agent-ubuntu-2204"
        matrix:
          - default
          - fleet
          - fqdn
          - upgrade

  - group: "arm:sudo:ubuntu:Stateful"
    key: integration-tests-ubuntu-arm
    steps:
      - label: "arm:{{matrix}}"
        command: |
          TEST_GROUP={{matrix}} TEST_SUDO=true mage -v integration:gettests
        artifact_paths:
          - build/**
        agents:
          provider: aws
          imagePrefix: "${AWS_IMAGE_UBUNTU_ARM_64}"
          instanceType: "${AWS_ARM_INSTANCE_TYPE}"
        matrix:
          - default
          - fleet
          - fqdn
          - upgrade
