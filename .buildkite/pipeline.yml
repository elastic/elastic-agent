# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"
  DOCKER_REGISTRY: "docker.elastic.co"

  IMAGE_UBUNTU_2204_X86_64: "platform-ingest-elastic-agent-ubuntu-2204-1749051876"
  IMAGE_UBUNTU_2204_ARM_64: "platform-ingest-elastic-agent-ubuntu-2204-aarch64"
  IMAGE_WIN_2016: "platform-ingest-elastic-agent-windows-2016-1749051876"
  IMAGE_WIN_2022: "platform-ingest-elastic-agent-windows-2022-1749051876"
  IMAGE_WIN_10: "platform-ingest-elastic-agent-windows-10-1749051876"
  IMAGE_WIN_11: "platform-ingest-elastic-agent-windows-11-1749051876"

steps:
  # Trigger for pull requests
  - label: "Trigger Extended tests for Pull request"
    if: |
      (build.pull_request.id != null && !build.env("GITHUB_PR_LABELS") =~ /skip-it/) ||
      build.env("GITHUB_PR_TRIGGER_COMMENT") =~ /.*extended.*/

    plugins:
      - monorepo-diff#v1.2.0:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - internal/
                - dev-tools/
                - pkg/
                - deploy/
                - test_infra/
                - testing/
                - version/
                - specs/
                - .agent-versions.json
                - .go-version
                - .package-version
                - go.mod
                - go.sum
                - magefile.go
                - main.go

                - .buildkite/integration.pipeline.yml
                - .buildkite/bk.integration.pipeline.yml
                - .buildkite/pipeline.yml
                - .buildkite/scripts/
                - .buildkite/hooks/

              config:
                label: ":pipeline: Upload extended testing Pipeline"
                command: "buildkite-agent pipeline upload .buildkite/integration.pipeline.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  # Trigger for branches
  - label: "Triggering Extended tests for branches"
    if: build.pull_request.id == null
    trigger: "elastic-agent-extended-testing"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"
