# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"

  # The following images are defined here and their values will be updated by updatecli
  # Please do not change them manually.
  IMAGE_UBUNTU_2204_X86_64: "platform-ingest-elastic-agent-ubuntu-2204-1769648509"
  IMAGE_UBUNTU_2204_ARM_64: "platform-ingest-elastic-agent-ubuntu-2204-aarch64-1769648509"
  IMAGE_WIN_2016: "platform-ingest-elastic-agent-windows-2016-1769648509"
  IMAGE_WIN_2022: "platform-ingest-elastic-agent-windows-2022-1769648509"
  IMAGE_WIN_10: "platform-ingest-elastic-agent-windows-10-1769648509"
  IMAGE_WIN_11: "platform-ingest-elastic-agent-windows-11-1769648509"

steps:
  - label: "check-ci"
    key: "check-ci"
    command: ".buildkite/scripts/steps/check-ci.sh"
    agents:
      provider: "gcp"
      image: "${IMAGE_UBUNTU_2204_X86_64}"
    retry:
      manual:
        allowed: true

  - group: "Unit tests"
    key: "unit-tests"
    steps:
      - label: "Unit tests - Ubuntu 22.04"
        key: "unit-tests-2204"
        command: ".buildkite/scripts/steps/unit-tests.sh"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_2204_X86_64}"
          machineType: "n2-standard-8"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - Ubuntu 22.04 with requirefips build tag"
        key: "unit-tests-2204-fips-tag"
        command: ".buildkite/scripts/steps/unit-tests.sh"
        env:
          FIPS: "true"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_2204_X86_64}"
          machineType: "n2-standard-8"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - fips140=only Ubuntu 22.04"
        key: "unit-tests-2204-fips140-only"
        # Note: The GODEBUG=fips140=only environment variable must be set in the command itself (as opposed to
        # in the env block) so that it is applied *only* to the 'go' command invoked by the script, and
        # not to any other Go code executed as part of the Buildkite agent itself.
        command: 'GODEBUG="fips140=only" .buildkite/scripts/steps/unit-tests.sh'
        env:
          FIPS: "true"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_2204_X86_64}"
          machineType: "n2-standard-8"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - Ubuntu 22.04 ARM64"
        key: "unit-tests-2204-arm64"
        command: ".buildkite/scripts/steps/unit-tests.sh"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "aws"
          image: "${IMAGE_UBUNTU_2204_ARM_64}"
          diskSizeGb: 200
          instanceType: "m6g.xlarge"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - Windows 2022"
        key: "unit-tests-win2022"
        command: .buildkite/scripts/steps/unit-tests.ps1
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_WIN_2022}"
          machineType: "n2-standard-8"
          disk_size: 200
          disk_type: "pd-ssd"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - Windows 2016"
        key: "unit-tests-win2016"
        command: .buildkite/scripts/steps/unit-tests.ps1
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_WIN_2016}"
          machineType: "n2-standard-8"
          disk_size: 200
          disk_type: "pd-ssd"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

  - group: "macOS tests"
    key: "macos-unit-tests"
    steps:
      - label: "Unit tests - macOS 15 ARM"
        command: ".buildkite/scripts/steps/unit-tests.sh"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: orka
          imagePrefix: generic-base-15-arm-002
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      # Runs only on main and release branches
      - label: "Unit tests - macOS 13"
        command: ".buildkite/scripts/steps/unit-tests.sh"
        branches: "main 8.* 9.*"
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: orka
          imagePrefix: generic-13-ventura-x64
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

  - group: "Desktop Windows tests"
    key: "extended-windows"
    steps:
      - label: "Unit tests - Windows 10"
        key: "unit-tests-win10"
        command: .buildkite/scripts/steps/unit-tests.ps1
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_WIN_10}"
          machineType: "n2-standard-8"
          disk_type: "pd-ssd"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

      - label: "Unit tests - Windows 11"
        key: "unit-tests-win11"
        command: .buildkite/scripts/steps/unit-tests.ps1
        artifact_paths:
          - "build/TEST-*.html"
          - "build/TEST-*.xml"
          - "build/diagnostics/*"
          - "coverage-*.out"
        agents:
          provider: "gcp"
          image: "${IMAGE_WIN_11}"
          machineType: "n2-standard-8"
          disk_type: "pd-ssd"
        retry:
          automatic:
            limit: 1
          manual:
            allowed: true

  - label: ":junit: Junit annotate"
    agents:
      # requires at least "bash", "curl" and "git"
      image: "docker.elastic.co/ci-agent-images/buildkite-junit-annotate:1.0"
    plugins:
      - junit-annotate#v2.7.0:
          artifacts: "**TEST-*.xml"
          always-annotate: true
          run-in-docker: false
    depends_on:
      - step: "unit-tests-2204"
        allow_failure: true
      - step: "unit-tests-2204-fips-tag"
        allow_failure: true
      - step: "unit-tests-2204-fips140-only"
        allow_failure: true
      - step: "unit-tests-2204-arm64"
        allow_failure: true
      - step: "unit-tests-win2022"
        allow_failure: true
      - step: "unit-tests-win2016"
        allow_failure: true
      - step: "macos-unit-tests"
        allow_failure: true
      - step: "unit-tests-win10"
        allow_failure: true
      - step: "unit-tests-win11"
        allow_failure: true

  - group: "K8s tests"
    key: "k8s-tests"
    steps:
      - label: "K8s tests: {{matrix.k8s_version}}"
        env:
          K8S_VERSION: "v{{matrix.k8s_version}}"
          KIND_VERSION: "v0.27.0"
        command: ".buildkite/scripts/steps/k8s-tests.sh"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_2204_X86_64}"
        matrix:
          setup:
            k8s_version:
              - "1.33.0"
              - "1.32.0"
              - "1.31.0"
              - "1.30.0"
              - "1.29.4"
              - "1.28.9"
        retry:
          manual:
            allowed: true

  # Triggers a dynamic step: Sync K8s
  # Runs only on main and if k8s files are changed
  - label: "Trigger k8s sync"
    branches: main
    command: ".buildkite/scripts/steps/sync-k8s.sh"
    agents:
      provider: "gcp"
      image: "${IMAGE_UBUNTU_2204_X86_64}"
    env:
      GH_VERSION: "2.4.0"
    if_changed:
      include:
        - deploy/kubernetes/*
        - version/docs/version.asciidoc

  # Trigger for pull requests
  - label: "Trigger Extended tests for Pull request"
    if: |
      (build.pull_request.id != null && !build.env("GITHUB_PR_LABELS") =~ /skip-it/) ||
      build.env("GITHUB_PR_TRIGGER_COMMENT") =~ /.*extended.*/
    command: "buildkite-agent pipeline upload .buildkite/integration.pipeline.yml"
    env:
      BUILDKITE_PULL_REQUEST: ${BUILDKITE_PULL_REQUEST}
      BUILDKITE_PULL_REQUEST_BASE_BRANCH: ${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
      GITHUB_PR_LABELS: ${GITHUB_PR_LABELS}
    if_changed:
      include:
        - internal/**
        - dev-tools/**
        - pkg/**
        - deploy/**
        - test_infra/**
        - testing/**
        - version/**
        - specs/**
        - .agent-versions.json
        - .go-version
        - .package-version
        - go.mod
        - go.sum
        - magefile.go
        - main.go
        - .buildkite/integration.pipeline.yml
        - .buildkite/bk.integration.pipeline.yml
        - .buildkite/bk.integration-fips.pipeline.yml
        - .buildkite/pipeline.yml
        - .buildkite/scripts/**
        - .buildkite/hooks/**

  # Trigger for branches
  - label: "Triggering Extended tests for branches"
    if: build.pull_request.id == null
    trigger: "elastic-agent-extended-testing"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  # Trigger for pull requests - Serverless Beats Tests
  # this should help detecting issues earlier in the development cycle
  - label: "Trigger Serverless Beats Tests"
    if: build.pull_request.id != null
    trigger: "beats-agent-serverless-tests"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"
    if_changed:
      include:
        - .buildkite/serverless.beats.tests.yml
        - .buildkite/scripts/steps/beats_tests.sh
        - .buildkite/hooks/pre-command

  # NOTE: This should help detecting issues earlier in the development cycle
  # See https://github.com/elastic/elastic-agent/issues/11604
  - label: "Trigger Elastic Agent Package"
    if: build.pull_request.id != null
    commands:
      - .buildkite/scripts/steps/trigger-elastic-agent-package.sh
      - .buildkite/scripts/steps/trigger-elastic-agent-package.sh | buildkite-agent pipeline upload
    if_changed:
      include:
        - .buildkite/pipeline.elastic-agent-package.yml
        - .buildkite/scripts/steps/package.sh
        - .buildkite/scripts/steps/trigger-elastic-agent-package.sh
        - magefile.go
        - dev-tools/**/*

  # NOTE: This should help detecting issues earlier in the development cycle
  # See https://github.com/elastic/elastic-agent/pull/11725
  - label: "DRY RUN publish to serverless"
    if: build.pull_request.id != null && build.env("BUILDKITE_PULL_REQUEST_BASE_BRANCH") == "main"
    if_changed:
      include:
        - .buildkite/pipeline.yml
        - .buildkite/pipeline.agentless-app-release.yaml
        - .buildkite/scripts/steps/ecp-internal-release.sh
        - .buildkite/scripts/steps/integration-package.sh
        - .buildkite/scripts/steps/validate-agentless-docker-image.sh
    trigger: "agentless-serverless-release"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"
      message: "publish to serverless (dry-run) #${BUILDKITE_PULL_REQUEST}"
      env:
        DRY_RUN: "true"

  # wait for CI to be done
  - wait: ~

  - label: "Publish to serverless"
    branches: main
    trigger: "agentless-serverless-release"
    build:
      commit: "${BUILDKITE_COMMIT}"
