# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"
  DOCKER_REGISTRY: "docker.elastic.co"
steps:
  - label: "Unit tests - Ubuntu 22.04"
    key: "unit-tests-2204"
    command: ".buildkite/scripts/steps/unit-tests.sh"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: "gcp"
      image: "family/core-ubuntu-2204"
    retry:
      manual:
        allowed: true

  - label: "Unit tests - Ubuntu 22.04 ARM64"
    key: "unit-tests-2204-arm64"
    command: ".buildkite/scripts/steps/unit-tests.sh"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: "aws"
      imagePrefix: "core-ubuntu-2204-aarch64"
      diskSizeGb: 200
      instanceType: "m6g.4xlarge"
    retry:
      manual:
        allowed: true

  - label: "Unit tests - Windows 2022"
    key: "unit-tests-win2022"
    command: ".\\.buildkite\\scripts\\steps\\unit-tests.ps1"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: "gcp"
      image: "family/core-windows-2022"
      machine_type: "n2-standard-8"
      disk_size: 200
      disk_type: "pd-ssd"
    retry:
      manual:
        allowed: true

  - label: "Unit tests - Windows 2016"
    key: "unit-tests-win2016"
    command: ".\\.buildkite\\scripts\\steps\\unit-tests.ps1"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: "gcp"
      image: "family/core-windows-2016"
      machine_type: "n2-standard-8"
      disk_size: 200
      disk_type: "pd-ssd"
    retry:
      manual:
        allowed: true

  - label: "Unit tests - MacOS 13 ARM"
    key: "unit-tests-macos-13-arm"
    command: ".buildkite/scripts/steps/unit-tests.sh"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: orka
      imagePrefix: generic-13-ventura-arm
    retry:
      manual:
        allowed: true

  - label: "Unit tests - MacOS 13"
    key: "unit-tests-macos-13"
    command: ".buildkite/scripts/steps/unit-tests.sh"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
      - "coverage.out"
    agents:
      provider: orka
      imagePrefix: generic-13-ventura-x64
    retry:
      manual:
        allowed: true

  - label: "Merge coverage reports"
    key: "merge-coverage"
    env:
      BUILDKITE_REPO: "" # skip checkout
    command: "
      .buildkite/scripts/steps/merge.sh
      unit-tests-2204
      unit-tests-2204-arm64
      unit-tests-win2016
      unit-tests-win2022
      unit-tests-macos-13
      unit-tests-macos-13-arm
      "
    artifact_paths:
      - "build/TEST-**"
    agents:
      image: "golang:1.20.10"
    depends_on:
      - unit-tests-2204
      - unit-tests-2204-arm64
      - unit-tests-win2022
      - unit-tests-win2016
      - unit-tests-macos-13
      - unit-tests-macos-13-arm
    allow_dependency_failure: true

  - label: "Serverless integration test"
    key: "serverless-integration-tests"
    command: ".buildkite/scripts/steps/integration_tests.sh serverless integration:single TestMonitoringLogsShipped" #right now, run a single test in serverless mode as a sort of smoke test, instead of re-running the entire suite
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
    agents:
      provider: "gcp"
      machineType: "n1-standard-8"

  - label: "Integration tests"
    key: "integration-tests"
    command: ".buildkite/scripts/steps/integration_tests.sh stateful"
    artifact_paths:
      - "build/TEST-**"
      - "build/diagnostics/*"
    agents:
      provider: "gcp"
      machineType: "n1-standard-8"

  - wait: ~
    continue_on_failure: true
  - label: "Processing test results"
    agents:
      provider: "gcp"
    plugins:
      - junit-annotate#v2.4.1:
          artifacts: build/TEST-go-*.xml
