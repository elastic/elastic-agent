# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  DOCKER_REGISTRY: "docker.elastic.co"
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"

steps:
  - label: "Serverless Beats Tests"
    key: "serverless-beats-integration-tests"
    concurrency_group: elastic-agent-extended-testing/beats-integration
    concurrency: 8
    retry:
      automatic:
        limit: 1
    env:
      TEST_INTEG_AUTH_GCP_DATACENTER: "us-central1-a"
    command: |
      buildkite-agent artifact download "build/distributions/**" . $BUILDKITE_BUILD_ID
      .buildkite/scripts/steps/beats_tests.sh
    agents:
      provider: "gcp"
      machineType: "n2-standard-8"
    notify:
      - github_commit_status:
          context: "buildkite/elastic-agent-extended-testing - Serverless Beats Tests"
