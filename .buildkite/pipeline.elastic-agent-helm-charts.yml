# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

steps:

  - label: ":elastic-stack: Create helm chart"
    command: |
      .buildkite/scripts/steps/helm-charts.sh
    plugins:
      - elastic/oblt-google-auth#v1.0.0:
          lifetime: 1800 # seconds
    agents:
      provider: "gcp"
      machineType: "n1-standard-8"

  - wait: ~

  - label: ":elastic-stack: Publish helm chart"
    trigger: unified-release-publish-helm-charts
    build:
      env:
        # TODO: likely we need some kind of dynamic pipeline generation to capture the version
        CHARTS_URL: "https://storage.googleapis.com/elastic-agent-helm-chart/elastic-agent-${SEMVER_REGEX}.tgz"
        # TODO: this env should be customized based on the environment
        HELM_REPO_ENV: dev
