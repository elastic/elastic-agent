# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

common:
  - vault_ec_key_prod: &vault_ec_key_prod
      elastic/vault-secrets#v0.1.0:
        path: "kv/ci-shared/platform-ingest/platform-ingest-ec-prod"
        field: "apiKey"
        env_var: "EC_API_KEY"

steps:
  - label: "Packaging: darwin/arm64"
    key: packaging-macos-arm64
    env:
      PLATFORMS: "darwin/arm64"
      PACKAGES: "tar.gz"
    command: ".buildkite/scripts/steps/integration-package.sh"
    artifact_paths:
      - build/distributions/**
    retry:
      automatic:
        limit: 1
    agents:
      provider: "aws"
      instanceType: "c6g.4xlarge"
      imagePrefix: "core-ubuntu-2204-aarch64"

  - label: Start ESS stack for macOS
    key: integration-macos-ess
    depends_on: packaging-macos-arm64
    env:
      ASDF_TERRAFORM_VERSION: 1.9.2
    command: |
      #!/usr/bin/env bash
      set -euo pipefail
      source .buildkite/scripts/steps/ess_start.sh
    artifact_paths:
      - test_infra/ess/*.tfstate
      - test_infra/ess/*.lock.hcl
    agents:
      image: "docker.elastic.co/ci-agent-images/platform-ingest/buildkite-agent-beats-ci-with-hooks:0.5"
      useCustomGlobalHooks: true
    plugins:
      - *vault_ec_key_prod

  - group: "Stateful: MacOS"
    key: integration-tests-macos
    depends_on:
      - integration-macos-ess    
    steps:
      - label: "macos:arm64:non-sudo: {{matrix}}"
        depends_on: packaging-macos-arm64
        env:
          TEST_PACKAGE: "github.com/elastic/elastic-agent/testing/integration/ess"  
        command: |
          source .buildkite/scripts/macos_install_asdf.sh
          buildkite-agent artifact download build/distributions/** . --step packaging-macos-arm64
          .buildkite/scripts/steps/integration_tests_tf.sh {{matrix}} false
        artifact_paths:
          - build/**
          - build/diagnostics/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: orka
          imagePrefix: generic-base-15-arm-002
        matrix:
          - default
      - label: "macos:arm64:sudo: {{matrix}}"
        depends_on: packaging-macos-arm64
        env:
          TEST_PACKAGE: "github.com/elastic/elastic-agent/testing/integration/ess"  
        command: |
          buildkite-agent artifact download build/distributions/** . --step packaging-macos-arm64
          source .buildkite/scripts/macos_install_asdf.sh
          .buildkite/scripts/steps/integration_tests_tf.sh {{matrix}} true
        artifact_paths:
          - build/**
          - build/diagnostics/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: orka
          imagePrefix: generic-base-15-arm-002
        matrix:
          - default

  - label: MacOS ESS stack cleanup
    depends_on:
      - integration-tests-macos
    allow_dependency_failure: true
    command: |
      buildkite-agent artifact download "test_infra/ess/**" . --step "integration-macos-ess"
      .buildkite/scripts/steps/ess_down.sh
    agents:
      image: "docker.elastic.co/ci-agent-images/platform-ingest/buildkite-agent-beats-ci-with-hooks:0.5"
      useCustomGlobalHooks: true
