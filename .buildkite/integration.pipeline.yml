# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

env:
  DOCKER_REGISTRY: "docker.elastic.co"
  VAULT_PATH: "kv/ci-shared/observability-ingest/cloud/gcp"

# This section is used to define the plugins that will be used in the pipeline.
# See https://buildkite.com/docs/pipelines/integrations/plugins/using#using-yaml-anchors-with-plugins
common:
  - google_oidc_plugin: &google_oidc_plugin
      # See https://github.com/elastic/oblt-infra/blob/main/conf/resources/repos/elastic-agent/01-gcp-oidc.tf
      # This plugin authenticates to Google Cloud using the OIDC token.
      elastic/oblt-google-auth#v1.3.0:
        lifetime: 10800 # seconds
        project-id: "elastic-observability-ci"
        project-number: "911195782929"
# see https://github.com/avaly/gcp-secret-manager-buildkite-plugin/pull/10
#  - gcp_serverless_secrets_plugin: &gcp_serverless_secrets_plugin
      #avaly/gcp-secret-manager#v1.2.0:
  - gcp_serverless_secrets_plugin: &gcp_serverless_secrets_plugin
      v1v/gcp-secret-manager#v1.3.0:
        env:
          # These secrets are created in .github/workflows/serverless-project.yml
          ELASTICSEARCH_HOST: ea-serverless-it-elasticsearch-hostname
          ELASTICSEARCH_PASSWORD: ea-serverless-it-elasticsearch-password
          ELASTICSEARCH_USERNAME: ea-serverless-it-elasticsearch-username
          KIBANA_HOST: ea-serverless-it-kibana-hostname
          KIBANA_USERNAME: ea-serverless-it-kibana-username
          KIBANA_PASSWORD: ea-serverless-it-kibana-password

steps:
  - group: "Integration tests: packaging"
    key: "int-packaging"
    steps:
      # Build matrix is not used for packaging in favor to unique step keys
      # Packaging linux/amd64
      - label: "Packaging: linux/amd64 rpm"
        key: packaging-ubuntu-x86-64
        env:
          PLATFORMS: "linux/amd64"
          PACKAGES: "tar.gz,rpm,deb"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"

      - label: "Packaging: Ubuntu x86_64 FIPS"
        key: "packaging-ubuntu-x86-64-fips"
        env:
          PACKAGES: "tar.gz"
          PLATFORMS: "linux/amd64"
          FIPS: "true"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-4"

      # Packaging linux/arm64
      - label: "Packaging: linux/arm64 tar.gz"
        key: packaging-ubuntu-arm64
        env:
          PLATFORMS: "linux/arm64"
          PACKAGES: "tar.gz"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "aws"
          instanceType: "c6g.4xlarge"
          imagePrefix: "core-ubuntu-2204-aarch64"

      - label: "Packaging: Ubuntu arm64 FIPS"
        key: "packaging-ubuntu-arm64-fips"
        env:
          PACKAGES: "tar.gz"
          PLATFORMS: "linux/arm64"
          FIPS: "true"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "aws"
          instanceType: "c6g.4xlarge"
          imagePrefix: "core-ubuntu-2204-aarch64"

      - label: "Packaging: windows/amd64 zip"
        key: packaging-windows
        env:
          PACKAGES: "zip"
          PLATFORMS: "windows/amd64"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"

      - label: "Packaging: Containers linux/amd64"
        key: packaging-containers-x86-64
        env:
          PACKAGES: "docker"
          PLATFORMS: "linux/amd64"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"
          diskSizeGb: 200

      - label: "Packaging: Containers linux/arm64"
        key: packaging-containers-arm64
        env:
          PACKAGES: "docker"
          PLATFORMS: "linux/arm64"
        command: |
          .buildkite/scripts/steps/integration-package.sh
        artifact_paths:
          - build/distributions/**
        agents:
          provider: "aws"
          instanceType: "c6g.4xlarge"
          imagePrefix: "core-ubuntu-2204-aarch64"
          diskSizeGb: 200

      - label: "Packaging: Containers linux/amd64 FIPS"
        key: packaging-containers-x86-64-fips
        env:
          PACKAGES: "docker"
          PLATFORMS: "linux/amd64"
          FIPS: "true"
        command: ".buildkite/scripts/steps/integration-package.sh"
        artifact_paths:
          - build/distributions/**
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"
          diskSizeGb: 200

      - label: "Packaging: Containers linux/arm64 FIPS"
        key: packaging-containers-arm64-fips
        env:
          PACKAGES: "docker"
          PLATFORMS: "linux/arm64"
          FIPS: "true"
        command: |
          .buildkite/scripts/steps/integration-package.sh
        artifact_paths:
          - build/distributions/**
        agents:
          provider: "aws"
          instanceType: "c6g.4xlarge"
          imagePrefix: "core-ubuntu-2204-aarch64"
          diskSizeGb: 200

  - group: "Serverless integration test (oblt-cli)"
    key: serverless-integration-tests
    notify:
      - github_commit_status:
          context: "buildkite/elastic-agent-extended-testing - Serverless integration test (oblt-cli)"
    steps:
      - label: "Windows:2022:amd64:sudo"
        depends_on:
          - packaging-windows
        command: |
          buildkite-agent artifact download build/distributions/** . --step 'packaging-windows'
          .buildkite/scripts/steps/serverless-integration-tests.ps1
        artifact_paths:
          - build/**
          - build/diagnostics/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"
          # TODO: replace with IMAGE_WIN_2022 when we migrate this in bk.integration.pipeline.yml
          image: "platform-ingest-elastic-agent-windows-2022-1749112555"
        plugins:
          - *google_oidc_plugin
          - *gcp_serverless_secrets_plugin
      - label: "Windows:2025:amd64:sudo"
        depends_on:
          - packaging-windows
        command: |
          buildkite-agent artifact download build/distributions/** . --step 'packaging-windows'
          .buildkite/scripts/steps/serverless-integration-tests.ps1
        artifact_paths:
          - build/**
          - build/diagnostics/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"
          # TODO: replace with IMAGE_WIN_2025 when we migrate this in bk.integration.pipeline.yml
          image: "platform-ingest-elastic-agent-windows-2025-1749112555"
        plugins:
          - *google_oidc_plugin
          - *gcp_serverless_secrets_plugin
      - label: "Ubuntu:2404:amd64:sudo"
        depends_on: packaging-ubuntu-x86-64
        command: |
          buildkite-agent artifact download build/distributions/** . --step 'packaging-ubuntu-x86-64'
          .buildkite/scripts/steps/serverless-integration-tests.sh
        artifact_paths:
          - build/**
          - build/diagnostics/**
        retry:
          automatic:
            limit: 1
        agents:
          provider: "gcp"
          imageProject: elastic-images-qa
          machineType: "n2-standard-8"
          # TODO: replace with IMAGE_UBUNTU_2404_X86_64 when we migrate this in bk.integration.pipeline.yml
          image: "platform-ingest-elastic-agent-ubuntu-2404-1749112555"
        plugins:
          - *google_oidc_plugin
          - *gcp_serverless_secrets_plugin

  - label: "Triggering Integration tests"
    depends_on:
      - int-packaging
    command: "buildkite-agent pipeline upload .buildkite/bk.integration.pipeline.yml"
