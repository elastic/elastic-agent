# This pipeline serves as the entry point for your service's quality gates definitions. When
# properly configured, it will be invoked automatically as part of the automated
# promotion process once a new version was rolled out in one of the various cloud stages.
#
# The updated environment is provided via ENVIRONMENT variable. The seedling
# step will branch and execute pipeline snippets at the following location:
# .buildkite/pipeline.tests-qa.yaml
# .buildkite/pipeline.tests-staging.yaml
# .buildkite/pipeline.tests-production.yaml
#
# Docs: https://docs.elastic.dev/serverless/qualitygates

env:
  ENVIRONMENT: ${ENVIRONMENT?}
  TEAM_CHANNEL: "#agentless-alerts"

steps:
  - label: ":docker: Validate docker image is built for all architectures"
    command: ".buildkite/scripts/steps/validate-agentless-docker-image.sh"
    agents:
      image: "docker.elastic.co/ci-agent-images/observability/oci-image-tools-agent:latest@sha256:a4ababd1347111759babc05c9ad5a680f4af48892784951358488b7e7fc94af9"
    plugins:
      - elastic/vault-docker-login#v0.6.3:
          secret_path: 'kv/ci-shared/platform-ingest/elastic_docker_registry'

  - wait

  - label: ":pipeline::grey_question::seedling: Trigger service tests for ${ENVIRONMENT}"
    command: ".buildkite/scripts/steps/run-agentless-tests.sh"
    agents:
      image: "docker.elastic.co/ci-agent-images/quality-gate-seedling:0.0.4@sha256:b15aa65183fd9ac4b3ad2b01287ee8c47382a74450485b012bade5331fefeae9"

notify:
  - slack: "${TEAM_CHANNEL}"
    if: build.branch == "main" && build.state == "failed"
