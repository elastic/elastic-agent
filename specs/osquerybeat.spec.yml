version: 2
inputs:
  - name: osquery
    description: "Osquery"
    platforms:
      - linux/amd64
      - linux/arm64
      - darwin/amd64
      - darwin/arm64
      - windows/amd64
      - container/amd64
      - container/arm64
    outputs:
      - elasticsearch
    command:
      args:
        - "-E"
        - "setup.ilm.enabled=false"
        - "-E"
        - "setup.template.enabled=false"
        - "-E"
        - "management.enabled=true"
        - "-E"
        - "logging.level=debug"
        - "-E"
        - "gc_percent=${OSQUERYBEAT_GOGC:100}"

# backward compatibility, remove with new inputs
restart_on_output_change: true
action_input_types:
- osquery

check_install:
- exec_file:
    path: "osquerybeat"
    args:
    - "verify"
    timeout: 10

rules:
- fix_stream: {}
- inject_index:
    type: logs

- inject_stream_processor:
    on_conflict: insert_after
    type: logs

- filter_values:
    selector: inputs
    key: type
    values:
    - osquery

- inject_agent_info: {}

- filter:
    selectors:
    - inputs
    - output

when: length(${inputs}) > 0 and hasKey(${output}, 'elasticsearch')
constraints: ${runtime.arch} != '386'