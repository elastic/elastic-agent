# Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
# or more contributor license agreements. Licensed under the Elastic License 2.0;
# you may not use this file except in compliance with the Elastic License 2.0.

# Dockerfile for elastic-agent using build args and multi-stage builds
# Uses ARG-based configuration instead of Go template expansion
# Each variant has its own target stage that extends from final-base

# =============================================================================
# Build arguments
# =============================================================================
ARG BUILD_FROM=cgr.dev/chainguard/wolfi-base
ARG FROM_IMAGE=redhat/ubi9-minimal
ARG BEAT_NAME=elastic-agent
ARG BEAT_VERSION=8.0.0
ARG BEAT_SNAPSHOT=false
ARG BEAT_VENDOR=Elastic
ARG BEAT_LICENSE=Elastic License 2.0
ARG BEAT_URL=https://www.elastic.co/elastic-agent
ARG BEAT_DESCRIPTION=Elastic Agent
ARG COMMIT=unknown
ARG COMMIT_SHORT=unknown
ARG BUILD_DATE=unknown
ARG VCS_URL=github.com/elastic/elastic-agent
ARG USER_NAME=elastic-agent
ARG LINUX_CAPABILITIES=
ARG VARIANT=basic
ARG NODE_VERSION=22.22.0

# =============================================================================
# Stage: home-prep-wolfi
# Prepare home directory using wolfi (has required tools like setcap)
# =============================================================================
FROM cgr.dev/chainguard/wolfi-base AS home-prep-wolfi

RUN for iter in 1 2 3 4 5 6 7 8 9 10; do \
        apk fix && \
        apk add --no-cache shadow libcap-utils findutils && \
        exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
    done; \
    exit $exit_code

# =============================================================================
# Stage: home
# Common home directory preparation (uses wolfi for setcap support)
# =============================================================================
FROM home-prep-wolfi AS home

ARG BEAT_NAME
ARG COMMIT_SHORT
ARG LINUX_CAPABILITIES

COPY beat /usr/share/${BEAT_NAME}

# Set up directory structure and permissions
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    chmod 0777 ${BEAT_HOME} && \
    mkdir -p ${BEAT_HOME}/data ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/logs && \
    find ${BEAT_HOME} -type d -exec chmod 0755 {} \; && \
    find ${BEAT_HOME} -type f -exec chmod 0644 {} \; && \
    find ${BEAT_HOME}/data -type d -exec chmod 0777 {} \; && \
    find ${BEAT_HOME}/data -type f -exec chmod 0666 {} \; && \
    rm -f ${BEAT_HOME}/${BEAT_NAME} && \
    ln -s ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/elastic-agent ${BEAT_HOME}/${BEAT_NAME}

# Set executable permissions on binaries
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/elastic-agent && \
    chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/elastic-otel-collector && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/cloudbeat || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/osquery* || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/apm-server || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/cloud-defend || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/endpoint-security || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/fleet-server || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-elastic-collector || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-elastic-symbolizer || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-host-agent || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/otelcol || true) && \
    (chmod 0755 ${BEAT_HOME}/otelcol || true) && \
    find ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/components -name "*.yml*" -type f -exec chmod 0644 {} \;

# Set permissions for optional directories
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    for dir in modules.d hints.inputs.d; do \
        if [ -d "${BEAT_HOME}/${dir}" ]; then \
            chmod 0775 ${BEAT_HOME}/${dir}; \
        fi; \
    done

# Set capabilities (must be after any permission changes)
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    setcap =p ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/elastic-agent || true; \
    if [ -n "${LINUX_CAPABILITIES}" ]; then \
        setcap "${LINUX_CAPABILITIES}" $(readlink -f ${BEAT_HOME}/${BEAT_NAME}) || true; \
    fi

# =============================================================================
# Stage: tini
# Download and verify tini init process
# =============================================================================
FROM cgr.dev/chainguard/wolfi-base AS tini

RUN apk add --no-cache curl

RUN set -e; \
    TINI_VERSION="v0.19.0"; \
    case "$(arch)" in \
        x86_64) \
            TINI_BIN="tini-amd64"; \
            TINI_SHA256="93dcc18adc78c65a028a84799ecf8ad40c936fdfc5f2a57b1acda5a8117fa82c"; \
            ;; \
        aarch64) \
            TINI_BIN="tini-arm64"; \
            TINI_SHA256="07952557df20bfd2a95f9bef198b445e006171969499a1d361bd9e6f8e5e0e81"; \
            ;; \
        *) \
            echo >&2 "Unsupported architecture $(arch)"; exit 1; \
            ;; \
    esac; \
    curl --retry 8 -S -L -O "https://github.com/krallin/tini/releases/download/${TINI_VERSION}/${TINI_BIN}"; \
    echo "${TINI_SHA256} ${TINI_BIN}" | sha256sum -c -; \
    mv "${TINI_BIN}" /tini; \
    chmod +x /tini

# =============================================================================
# Stage: final-base
# Common base for all variants
# =============================================================================
FROM ${FROM_IMAGE} AS final-base

ARG BEAT_NAME
ARG BEAT_VERSION
ARG BEAT_SNAPSHOT
ARG BEAT_VENDOR
ARG BEAT_LICENSE
ARG BEAT_URL
ARG BEAT_DESCRIPTION
ARG COMMIT
ARG COMMIT_SHORT
ARG BUILD_DATE
ARG VCS_URL
ARG USER_NAME
ARG VARIANT
ARG FROM_IMAGE
ARG NODE_VERSION

# Install base packages based on image type and variant
RUN set -eux; \
    if echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            apk fix && \
            apk add --no-cache ca-certificates curl gawk shadow bash && \
            exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
    else \
        case "${VARIANT}" in \
            basic|ubi|elastic-otel-collector|elastic-otel-collector-wolfi|complete) \
                for iter in 1 2 3 4 5 6 7 8 9 10; do \
                    microdnf update -y && \
                    microdnf install -y tar gzip findutils shadow-utils ca-certificates gawk libcap xz systemd && \
                    microdnf clean all && \
                    exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
                done; \
                exit $exit_code;; \
            *) \
                for iter in 1 2 3 4 5 6 7 8 9 10; do \
                    microdnf update -y && \
                    microdnf install -y tar gzip findutils shadow-utils ca-certificates gawk libcap xz && \
                    microdnf clean all && \
                    exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
                done; \
                exit $exit_code;; \
        esac; \
    fi

# Copy tini from builder stage
COPY --from=tini /tini /usr/bin/tini

# Copy entrypoint
COPY docker-entrypoint /usr/local/bin/docker-entrypoint

# Create user and group
RUN set -eux; \
    groupadd --gid 1000 ${BEAT_NAME}; \
    if echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        useradd -M --uid 1000 --gid 1000 ${USER_NAME}; \
    else \
        useradd -M --uid 1000 --gid 1000 --groups 0 ${USER_NAME}; \
    fi; \
    chmod 755 /usr/local/bin/docker-entrypoint

# Copy home directory from builder stage
COPY --from=home --chown=${USER_NAME}:${USER_NAME} /usr/share/${BEAT_NAME} /usr/share/${BEAT_NAME}

# Set up home directory permissions
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    chmod 0777 ${BEAT_HOME} && \
    usermod -d ${BEAT_HOME} ${USER_NAME} && \
    find ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/components -name "*.yml*" -type f -exec chown ${USER_NAME}:${USER_NAME} {} \; || true

# Set up licenses
RUN mkdir -p /licenses
COPY --from=home /usr/share/${BEAT_NAME}/LICENSE.txt /licenses/
COPY --from=home /usr/share/${BEAT_NAME}/NOTICE.txt /licenses/

# Labels
LABEL \
  org.label-schema.build-date="${BUILD_DATE}" \
  org.label-schema.schema-version="1.0" \
  org.label-schema.vendor="${BEAT_VENDOR}" \
  org.label-schema.license="${BEAT_LICENSE}" \
  org.label-schema.name="${BEAT_NAME}" \
  org.label-schema.version="${BEAT_VERSION}" \
  org.label-schema.url="${BEAT_URL}" \
  org.label-schema.vcs-url="${VCS_URL}" \
  org.label-schema.vcs-ref="${COMMIT}" \
  io.k8s.description="${BEAT_DESCRIPTION}" \
  io.k8s.display-name="${BEAT_NAME} image" \
  org.opencontainers.image.created="${BUILD_DATE}" \
  org.opencontainers.image.licenses="${BEAT_LICENSE}" \
  org.opencontainers.image.title="${BEAT_NAME}" \
  org.opencontainers.image.vendor="${BEAT_VENDOR}" \
  org.opencontainers.image.authors="infra@elastic.co" \
  maintainer="infra@elastic.co" \
  name="${BEAT_NAME}" \
  vendor="${BEAT_VENDOR}" \
  version="${BEAT_VERSION}" \
  release="1" \
  url="${BEAT_URL}" \
  summary="${BEAT_NAME}" \
  license="${BEAT_LICENSE}" \
  description="${BEAT_DESCRIPTION}"

# Environment variables
ENV BEAT_SETUID_AS=${USER_NAME}
ENV ELASTIC_CONTAINER="true"
ENV PATH=/usr/share/${BEAT_NAME}:$PATH
ENV GODEBUG="madvdontneed=1"
ENV TZ=UTC
ENV LIBBEAT_MONITORING_CGROUPS_HIERARCHY_OVERRIDE=/

WORKDIR /usr/share/${BEAT_NAME}

ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/docker-entrypoint"]

# =============================================================================
# Stage: basic
# Basic UBI variant - no additional setup needed
# =============================================================================
FROM final-base AS basic

ARG USER_NAME
USER ${USER_NAME}

# =============================================================================
# Stage: wolfi
# Wolfi variant - no additional setup needed
# =============================================================================
FROM final-base AS wolfi

ARG USER_NAME
USER ${USER_NAME}

# =============================================================================
# Stage: cloud
# Cloud variant with /opt filebeat/metricbeat scripts
# =============================================================================
FROM final-base AS cloud

ARG BEAT_NAME
ARG USER_NAME

RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    mkdir -p /app /opt/filebeat /opt/metricbeat && \
    chown ${USER_NAME}:${USER_NAME} /app && \
    if [ -d "${BEAT_HOME}/data/cloud_downloads" ]; then \
        cp -f ${BEAT_HOME}/data/cloud_downloads/filebeat.sh /opt/filebeat/filebeat && \
        chmod +x /opt/filebeat/filebeat && \
        cp -f ${BEAT_HOME}/data/cloud_downloads/metricbeat.sh /opt/metricbeat/metricbeat && \
        chmod +x /opt/metricbeat/metricbeat && \
        rm -rf ${BEAT_HOME}/data/cloud_downloads; \
    fi && \
    echo '#!/bin/sh' > /app/apm.sh && \
    echo 'exec /usr/local/bin/docker-entrypoint' >> /app/apm.sh && \
    chmod 0555 /app/apm.sh

USER ${USER_NAME}

# =============================================================================
# Stage: service
# Service variant with Python and connectors
# =============================================================================
FROM final-base AS service

ARG BEAT_NAME
ARG USER_NAME

RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    apk add --no-cache git make python-3.11 py3.11-pip unzip && \
    unzip ${BEAT_HOME}/data/service/connectors-*.zip -d ${BEAT_HOME}/data/service/connectors && \
    mv ${BEAT_HOME}/data/service/connectors /usr/share/connectors && \
    PYTHON=python3.11 make -C /usr/share/connectors clean install install-agent && \
    chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/connectors

USER ${USER_NAME}

# =============================================================================
# Stage: complete
# Complete UBI variant with Node.js, fonts, and synthetics
# =============================================================================
FROM final-base AS complete

ARG BEAT_NAME
ARG USER_NAME
ARG NODE_VERSION

# Install synthetics dependencies and Node.js
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    for iter in 1 2 3 4 5 6 7 8 9 10; do \
        microdnf -y update && \
        microdnf -y install fontconfig freetype cairo glib2 gtk3 pango xorg-x11-fonts-misc xorg-x11-fonts-Type1 \
        at-spi2-atk atk at-spi2-core alsa-lib cups-libs dbus-libs libdrm mesa-libEGL mesa-libgbm nspr nss libX11 \
        libX11-xcb libxcb libXcomposite libXdamage libXext libXfixes libXrandr libxkbcommon libxshmfence glib2 \
        dbus-glib libicu mesa-libGL unzip iptables && \
        microdnf clean all && \
        exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
    done; \
    # Download and install Node.js
    mkdir -p ${BEAT_HOME}/.node ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.npm ${BEAT_HOME}/.cache && \
    cd ${BEAT_HOME}/.node && \
    case "$(arch)" in \
        x86_64) NODE_DOWNLOAD_URL="https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz";; \
        aarch64) NODE_DOWNLOAD_URL="https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-arm64.tar.xz";; \
        *) echo >&2 "Unsupported architecture $(arch)"; exit 1;; \
    esac && \
    curl -fsSL ${NODE_DOWNLOAD_URL} | tar -xJ --strip 1 -C . && \
    chmod ugo+rwX -R ${BEAT_HOME}/.node && \
    chmod 0775 ${BEAT_HOME}/.node ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.npm ${BEAT_HOME}/.cache && \
    chown -R ${USER_NAME}:${USER_NAME} ${BEAT_HOME}/.node ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.npm ${BEAT_HOME}/.cache && \
    # Download and install fonts
    mkdir -p /usr/share/fonts/google-noto && \
    curl -fsSL -o NotoSansCJKjp.zip https://github.com/notofonts/noto-cjk/releases/download/Sans2.004/06_NotoSansCJKjp.zip && \
    unzip -q NotoSansCJKjp.zip -d /usr/share/fonts/google-noto && \
    rm -f NotoSansCJKjp.zip && \
    microdnf -y remove unzip && \
    curl -fsSL -o /usr/share/fonts/google-noto/NotoSans-Regular.ttf https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-Regular.ttf && \
    curl -fsSL -o /usr/share/fonts/google-noto/NotoColorEmoji.ttf https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoColorEmoji.ttf && \
    fc-cache -fv && \
    microdnf clean all

# Install synthetics as user
USER ${USER_NAME}
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    export PATH="${BEAT_HOME}/.node/bin:${PATH}"; \
    npm i -g --loglevel verbose --production --engine-strict @elastic/synthetics@stack_release && \
    chmod ugo+rwX -R ${BEAT_HOME}/.node

# =============================================================================
# Stage: complete-wolfi
# Complete Wolfi variant with Node.js and synthetics
# =============================================================================
FROM final-base AS complete-wolfi

ARG BEAT_NAME
ARG USER_NAME

ENV NPM_CONFIG_PREFIX=/usr/share/${BEAT_NAME}/.npm

# Install Node.js and synthetics dependencies
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    for iter in 1 2 3 4 5 6 7 8 9 10; do \
        apk fix && \
        apk add --no-interactive --no-progress --no-cache nodejs-22=22.22.0-r0 npm=11.4.2-r1 glib dbus-glib libatk-1.0 \
        libatk-bridge-2.0 cups-libs libxcomposite libxdamage libxrandr libxkbcommon pango alsa-lib \
        font-opensans fontconfig gtk icu-data-full libnss mesa font-noto-cjk font-noto-emoji && \
        exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
    done; \
    mkdir -m 0770 -p ${BEAT_HOME}/.npm ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.cache && \
    chown -R ${USER_NAME}:${USER_NAME} ${BEAT_HOME}/.npm ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.cache

# Install synthetics as user
USER ${USER_NAME}
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    export PATH="${NPM_CONFIG_PREFIX}/bin:${PATH}"; \
    npm i -g --loglevel verbose --production --engine-strict @elastic/synthetics@stack_release
