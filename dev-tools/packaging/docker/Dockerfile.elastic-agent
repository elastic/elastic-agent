# Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
# or more contributor license agreements. Licensed under the Elastic License 2.0;
# you may not use this file except in compliance with the Elastic License 2.0.

# Dockerfile for elastic-agent using build args instead of templates
# This is the non-templated version that can be used directly with docker build --build-arg

# Build arguments
ARG BUILD_FROM=cgr.dev/chainguard/wolfi-base
ARG FROM_IMAGE=redhat/ubi9-minimal
ARG BEAT_NAME=elastic-agent
ARG BEAT_VERSION=8.0.0
ARG BEAT_SNAPSHOT=false
ARG BEAT_VENDOR=Elastic
ARG BEAT_LICENSE=Elastic License 2.0
ARG BEAT_URL=https://www.elastic.co/elastic-agent
ARG BEAT_DESCRIPTION=Elastic Agent
ARG COMMIT=unknown
ARG COMMIT_SHORT=unknown
ARG BUILD_DATE=unknown
ARG VCS_URL=github.com/elastic/elastic-agent
ARG USER_NAME=elastic-agent
ARG LINUX_CAPABILITIES=
ARG VARIANT=basic
ARG NODE_VERSION=22.22.0

# Stage 1: Prepare home directory
FROM ${BUILD_FROM} AS home

ARG BEAT_NAME
ARG COMMIT_SHORT
ARG VARIANT
ARG USER_NAME
ARG LINUX_CAPABILITIES
ARG BUILD_FROM

# Install required tools based on base image
RUN set -eux; \
    if echo "${BUILD_FROM}" | grep -q "wolfi"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            apk fix && \
            apk add --no-cache shadow libcap-utils && \
            exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
    elif echo "${BUILD_FROM}" | grep -qE "redhat/ubi.*-minimal"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            microdnf update -y && \
            microdnf install -y findutils && \
            microdnf clean all && \
            exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
    fi

COPY beat /usr/share/${BEAT_NAME}

RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    # ECE needs to create config here under non-1000 user
    chmod 0777 ${BEAT_HOME} && \
    mkdir -p ${BEAT_HOME}/data ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/logs && \
    find ${BEAT_HOME} -type d -exec chmod 0755 {} \; && \
    find ${BEAT_HOME} -type f -exec chmod 0644 {} \; && \
    find ${BEAT_HOME}/data -type d -exec chmod 0777 {} \; && \
    find ${BEAT_HOME}/data -type f -exec chmod 0666 {} \; && \
    rm -f ${BEAT_HOME}/${BEAT_NAME} && \
    ln -s ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/elastic-agent ${BEAT_HOME}/${BEAT_NAME} && \
    chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/elastic-agent && \
    chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/elastic-otel-collector && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/cloudbeat || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/osquery* || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/apm-server || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/cloud-defend || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/endpoint-security || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/fleet-server || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-elastic-collector || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-elastic-symbolizer || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/pf-host-agent || true) && \
    (chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/otelcol || true) && \
    (chmod 0755 ${BEAT_HOME}/otelcol || true) && \
    find ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/components -name "*.yml*" -type f -exec chmod 0644 {} \;

# Set permissions for modules directories if present
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    for dir in modules.d hints.inputs.d; do \
        if [ -d "${BEAT_HOME}/${dir}" ]; then \
            chmod 0775 ${BEAT_HOME}/${dir}; \
        fi; \
    done; \
    true

# Handle cloud variant specific setup
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "cloud" ]; then \
        mkdir -p /opt/filebeat /opt/metricbeat && \
        cp -f ${BEAT_HOME}/data/cloud_downloads/filebeat.sh /opt/filebeat/filebeat && \
        chmod +x /opt/filebeat/filebeat && \
        cp -f ${BEAT_HOME}/data/cloud_downloads/metricbeat.sh /opt/metricbeat/metricbeat && \
        chmod +x /opt/metricbeat/metricbeat && \
        rm -rf ${BEAT_HOME}/data/cloud_downloads; \
    else \
        mkdir -p /opt; \
    fi

# Set capabilities - keep this after any chown command as chown resets capabilities
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    setcap =p ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/elastic-agent || true; \
    if [ -n "${LINUX_CAPABILITIES}" ]; then \
        setcap "${LINUX_CAPABILITIES}" $(readlink -f ${BEAT_HOME}/${BEAT_NAME}) || true; \
    fi; \
    true

# Stage 2: Final image
FROM ${FROM_IMAGE}

ARG BEAT_NAME
ARG BEAT_VERSION
ARG BEAT_SNAPSHOT
ARG BEAT_VENDOR
ARG BEAT_LICENSE
ARG BEAT_URL
ARG BEAT_DESCRIPTION
ARG COMMIT
ARG COMMIT_SHORT
ARG BUILD_DATE
ARG VCS_URL
ARG USER_NAME
ARG VARIANT
ARG FROM_IMAGE
ARG NODE_VERSION

ENV BEAT_SETUID_AS=${USER_NAME}

# Install base dependencies based on the image type
RUN set -eux; \
    if echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            apk fix && \
            apk add --no-cache ca-certificates curl gawk shadow bash && \
            exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
    else \
        case "${VARIANT}" in \
            basic|ubi|elastic-otel-collector|complete) \
                for iter in 1 2 3 4 5 6 7 8 9 10; do \
                    microdnf update -y && \
                    microdnf install -y tar gzip findutils shadow-utils ca-certificates gawk libcap xz systemd && \
                    microdnf clean all && \
                    exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
                done; \
                exit $exit_code;; \
            *) \
                for iter in 1 2 3 4 5 6 7 8 9 10; do \
                    microdnf update -y && \
                    microdnf install -y tar gzip findutils shadow-utils ca-certificates gawk libcap xz && \
                    microdnf clean all && \
                    exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
                done; \
                exit $exit_code;; \
        esac; \
    fi

LABEL \
  org.label-schema.build-date="${BUILD_DATE}" \
  org.label-schema.schema-version="1.0" \
  org.label-schema.vendor="${BEAT_VENDOR}" \
  org.label-schema.license="${BEAT_LICENSE}" \
  org.label-schema.name="${BEAT_NAME}" \
  org.label-schema.version="${BEAT_VERSION}" \
  org.label-schema.url="${BEAT_URL}" \
  org.label-schema.vcs-url="${VCS_URL}" \
  org.label-schema.vcs-ref="${COMMIT}" \
  io.k8s.description="${BEAT_DESCRIPTION}" \
  io.k8s.display-name="${BEAT_NAME} image" \
  org.opencontainers.image.created="${BUILD_DATE}" \
  org.opencontainers.image.licenses="${BEAT_LICENSE}" \
  org.opencontainers.image.title="${BEAT_NAME}" \
  org.opencontainers.image.vendor="${BEAT_VENDOR}" \
  org.opencontainers.image.authors="infra@elastic.co" \
  maintainer="infra@elastic.co" \
  name="${BEAT_NAME}" \
  vendor="${BEAT_VENDOR}" \
  version="${BEAT_VERSION}" \
  release="1" \
  url="${BEAT_URL}" \
  summary="${BEAT_NAME}" \
  license="${BEAT_LICENSE}" \
  description="${BEAT_DESCRIPTION}"

ENV ELASTIC_CONTAINER="true"
ENV PATH=/usr/share/${BEAT_NAME}:$PATH
ENV GODEBUG="madvdontneed=1"

# Add tini init process
RUN set -e ; \
  TINI_BIN=""; \
  TINI_SHA256=""; \
  TINI_VERSION="v0.19.0"; \
  case "$(arch)" in \
    x86_64) \
        TINI_BIN="tini-amd64"; \
        TINI_SHA256="93dcc18adc78c65a028a84799ecf8ad40c936fdfc5f2a57b1acda5a8117fa82c"; \
        ;; \
    aarch64) \
        TINI_BIN="tini-arm64"; \
        TINI_SHA256="07952557df20bfd2a95f9bef198b445e006171969499a1d361bd9e6f8e5e0e81"; \
        ;; \
    *) \
        echo >&2 ; echo >&2 "Unsupported architecture $(arch)" ; echo >&2 ; exit 1 ; \
        ;; \
  esac ; \
  curl --retry 8 -S -L -O "https://github.com/krallin/tini/releases/download/${TINI_VERSION}/${TINI_BIN}" ; \
  echo "${TINI_SHA256} ${TINI_BIN}" | sha256sum -c - ; \
  mv "${TINI_BIN}" /usr/bin/tini ; \
  chmod +x /usr/bin/tini

COPY docker-entrypoint /usr/local/bin/docker-entrypoint

# Create user and group - wolfi doesn't add to root group
RUN set -eux; \
    groupadd --gid 1000 ${BEAT_NAME}; \
    if echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        useradd -M --uid 1000 --gid 1000 ${USER_NAME}; \
    else \
        useradd -M --uid 1000 --gid 1000 --groups 0 ${USER_NAME}; \
    fi; \
    chmod 755 /usr/local/bin/docker-entrypoint

COPY --chown=${USER_NAME}:${USER_NAME} --from=home /usr/share/${BEAT_NAME} /usr/share/${BEAT_NAME}

# Set permissions on home directory
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    chmod 0777 ${BEAT_HOME} && \
    usermod -d ${BEAT_HOME} ${USER_NAME} && \
    find ${BEAT_HOME}/data/elastic-agent-${COMMIT_SHORT}/components -name "*.yml*" -type f -exec chown ${USER_NAME}:${USER_NAME} {} \; || true

RUN mkdir /licenses
COPY --from=home /usr/share/${BEAT_NAME}/LICENSE.txt /licenses
COPY --from=home /usr/share/${BEAT_NAME}/NOTICE.txt /licenses

# Cloud variant specific setup
RUN set -eux; \
    if [ "${VARIANT}" = "cloud" ]; then \
        mkdir -p /app && \
        chown ${USER_NAME}:${USER_NAME} /app; \
    fi; \
    true

# Cloud variant: copy /opt from home stage (contains filebeat/metricbeat scripts)
# For non-cloud variants, /opt in home stage is empty so this is a no-op
COPY --from=home /opt /opt

# Service variant setup (wolfi only)
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "service" ]; then \
        apk add --no-cache git make python-3.11 py3.11-pip unzip && \
        unzip ${BEAT_HOME}/data/service/connectors-*.zip -d ${BEAT_HOME}/data/service/connectors && \
        mv ${BEAT_HOME}/data/service/connectors /usr/share/connectors && \
        PYTHON=python3.11 make -C /usr/share/connectors clean install install-agent && \
        chmod 0755 ${BEAT_HOME}/data/elastic-agent-*/components/connectors; \
    fi; \
    true

# Complete (UBI) variant setup - Node.js and synthetics
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "complete" ] && echo "${FROM_IMAGE}" | grep -qE "redhat/ubi.*-minimal"; then \
        NODE_PATH="${BEAT_HOME}/.node"; \
        echo ${NODE_PATH} ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.npm ${BEAT_HOME}/.cache \
            | xargs -IDIR sh -c 'mkdir -p DIR && chmod 0775 DIR'; \
    fi; \
    true

# Install Node.js for complete UBI variant
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "complete" ] && echo "${FROM_IMAGE}" | grep -qE "redhat/ubi.*-minimal"; then \
        NODE_PATH="${BEAT_HOME}/.node"; \
        cd ${NODE_PATH}; \
        NODE_DOWNLOAD_URL=""; \
        case "$(arch)" in \
            x86_64) \
                NODE_DOWNLOAD_URL="https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz";; \
            aarch64) \
                NODE_DOWNLOAD_URL="https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-arm64.tar.xz";; \
            *) \
                echo >&2 "Unsupported architecture $(arch)"; exit 1;; \
        esac; \
        mkdir -p node && \
        curl ${NODE_DOWNLOAD_URL} | tar -xJ --strip 1 -C node && \
        chmod ugo+rwX -R ${NODE_PATH} && \
        chown -R ${USER_NAME}:${USER_NAME} ${NODE_PATH}; \
    fi; \
    true

# Install synthetics for complete UBI variant (as user)
USER ${USER_NAME}
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "complete" ] && echo "${FROM_IMAGE}" | grep -qE "redhat/ubi.*-minimal"; then \
        NODE_PATH="${BEAT_HOME}/.node"; \
        export PATH="${NODE_PATH}/node/bin:${PATH}"; \
        (npm i -g --loglevel verbose --production --engine-strict @elastic/synthetics@stack_release || sh -c 'tail -n +1 ~/.npm/_logs/* && exit 1') && \
        chmod ugo+rwX -R ${NODE_PATH}; \
    fi; \
    true
USER root

# Install Playwright dependencies for complete UBI variant
RUN set -eux; \
    if [ "${VARIANT}" = "complete" ] && echo "${FROM_IMAGE}" | grep -qE "redhat/ubi.*-minimal"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            microdnf -y update && \
            microdnf -y install fontconfig freetype cairo glib2 gtk3 pango xorg-x11-fonts-misc xorg-x11-fonts-Type1 \
            at-spi2-atk atk at-spi2-core alsa-lib cups-libs dbus-libs libdrm mesa-libEGL mesa-libgbm nspr nss libX11 \
            libX11-xcb libxcb libXcomposite libXdamage libXext libXfixes libXrandr libxkbcommon libxshmfence glib2 \
            dbus-glib libicu mesa-libGL unzip iptables && \
            mkdir -p /usr/share/fonts/google-noto && \
            curl -L -o NotoSansCJKjp.zip https://github.com/notofonts/noto-cjk/releases/download/Sans2.004/06_NotoSansCJKjp.zip && \
            unzip NotoSansCJKjp.zip -d /usr/share/fonts/google-noto && \
            rm -f NotoSansCJKjp.zip && \
            microdnf -y remove unzip && \
            curl -LO https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-Regular.ttf && \
            mv NotoSans-Regular.ttf /usr/share/fonts/google-noto && \
            curl -LO https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoColorEmoji.ttf && \
            mv NotoColorEmoji.ttf /usr/share/fonts/google-noto && \
            fc-cache -fv && \
            microdnf clean all && \
            exit_code=0 && break || exit_code=$? && echo "microdnf error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
    fi; \
    true

# Complete-wolfi variant setup
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "complete-wolfi" ] && echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        for iter in 1 2 3 4 5 6 7 8 9 10; do \
            apk fix && \
            apk add --no-interactive --no-progress --no-cache nodejs-22=22.22.0-r0 npm=11.4.2-r1 glib dbus-glib libatk-1.0 \
            libatk-bridge-2.0 cups-libs libxcomposite libxdamage libxrandr libxkbcommon pango alsa-lib \
            font-opensans fontconfig gtk icu-data-full libnss mesa font-noto-cjk font-noto-emoji && \
            exit_code=0 && break || exit_code=$? && echo "apk error: retry $iter in 10s" && sleep 10; \
        done; \
        exit $exit_code; \
        NPM_CONFIG_PREFIX="${BEAT_HOME}/.npm"; \
        echo ${NPM_CONFIG_PREFIX} ${BEAT_HOME}/.config ${BEAT_HOME}/.synthetics ${BEAT_HOME}/.npm ${BEAT_HOME}/.cache \
            | xargs -IDIR sh -c 'mkdir -m 0770 -p DIR && chown -R ${USER_NAME} DIR'; \
    fi; \
    true

USER ${USER_NAME}
RUN set -eux; \
    BEAT_HOME="/usr/share/${BEAT_NAME}"; \
    if [ "${VARIANT}" = "complete-wolfi" ] && echo "${FROM_IMAGE}" | grep -q "wolfi"; then \
        NPM_CONFIG_PREFIX="${BEAT_HOME}/.npm"; \
        export PATH="${NPM_CONFIG_PREFIX}/bin:${PATH}"; \
        (npm i -g --loglevel verbose --production --engine-strict @elastic/synthetics@stack_release || sh -c 'tail -n +1 ${NPM_CONFIG_PREFIX}/_logs/* && exit 1'); \
    fi; \
    true

USER ${USER_NAME}

# Environment for complete variants
ENV TZ=UTC

# When running under Docker, we must ensure libbeat monitoring pulls cgroup
# metrics from /sys/fs/cgroup/<subsystem>/, ignoring any paths found in
# /proc/self/cgroup.
ENV LIBBEAT_MONITORING_CGROUPS_HIERARCHY_OVERRIDE=/

WORKDIR /usr/share/${BEAT_NAME}

# Cloud variant uses different entrypoint
RUN set -eux; \
    if [ "${VARIANT}" = "cloud" ]; then \
        echo '#!/bin/sh' > /app/apm.sh && \
        echo 'exec /usr/local/bin/docker-entrypoint' >> /app/apm.sh && \
        chmod 0555 /app/apm.sh; \
    fi; \
    true

# Default entrypoint (cloud variant overrides CMD)
ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/docker-entrypoint"]
