// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

package conv

import (
	"testing"

	"github.com/google/go-cmp/cmp"
)

func TestFixMapPolicy4Real(t *testing.T) {
	var policyMap = map[string]interface{}{"agent": map[interface{}]interface{}{"download": map[interface{}]interface{}{"sourceURI": "https://artifacts.elastic.co/downloads/"}, "features": map[interface{}]interface{}{}, "monitoring": map[interface{}]interface{}{"enabled": true, "logs": true, "metrics": true, "namespace": "default", "use_output": "default"}, "protection": map[interface{}]interface{}{"enabled": true, "signing_key": "MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEahHlKqDRfAcOZn0DmQBC7nQ8MS7CBNd8TAvBRlZl/MILX0GVsyzUmOjo+icMx+Quv7X/qVFlNjHhuBIp+7/AGA==", "uninstall_token_hash": ""}}, "fleet": map[interface{}]interface{}{"hosts": []interface{}{"https://e68bf0a8e9c745f696dcbb808b6d7597.fleet.us-west2.gcp.elastic-cloud.com:443"}}, "id": "4d7d84e0-b46d-11ed-ba3a-57052bcc437f", "inputs": []interface{}{map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"namespace": "default"}, "id": "logfile-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[interface{}]interface{}{"package": map[interface{}]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.auth", "type": "logs"}, "exclude_files": []interface{}{".gz$"}, "id": "logfile-system.auth-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "multiline": map[interface{}]interface{}{"match": "after", "pattern": "^\\s"}, "paths": []interface{}{"/var/log/auth.log*", "/var/log/secure*"}, "processors": []interface{}{map[interface{}]interface{}{"add_locale": interface{}(nil)}}, "tags": []interface{}{"system-auth"}}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.syslog", "type": "logs"}, "exclude_files": []interface{}{".gz$"}, "id": "logfile-system.syslog-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "multiline": map[interface{}]interface{}{"match": "after", "pattern": "^\\s"}, "paths": []interface{}{"/var/log/messages*", "/var/log/syslog*"}, "processors": []interface{}{map[interface{}]interface{}{"add_locale": interface{}(nil)}}}}, "type": "logfile", "use_output": "default"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"namespace": "default"}, "id": "winlog-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[interface{}]interface{}{"package": map[interface{}]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[interface{}]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[interface{}]interface{}{"dataset": "system.application", "type": "logs"}, "id": "winlog-system.application-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "Application"}, map[interface{}]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[interface{}]interface{}{"dataset": "system.security", "type": "logs"}, "id": "winlog-system.security-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "Security"}, map[interface{}]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[interface{}]interface{}{"dataset": "system.system", "type": "logs"}, "id": "winlog-system.system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "System"}}, "type": "winlog", "use_output": "default"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"namespace": "default"}, "id": "system/metrics-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[interface{}]interface{}{"package": map[interface{}]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[interface{}]interface{}{"cpu.metrics": []interface{}{"percentages", "normalized_percentages"}, "data_stream": map[interface{}]interface{}{"dataset": "system.cpu", "type": "metrics"}, "id": "system/metrics-system.cpu-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"cpu"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.diskio", "type": "metrics"}, "diskio.include_devices": interface{}(nil), "id": "system/metrics-system.diskio-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"diskio"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.filesystem", "type": "metrics"}, "id": "system/metrics-system.filesystem-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"filesystem"}, "period": "1m", "processors": []interface{}{map[interface{}]interface{}{"drop_event.when.regexp": map[interface{}]interface{}{"system.filesystem.mount_point": "^/(sys|cgroup|proc|dev|etc|host|lib|snap)($|/)"}}}}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.fsstat", "type": "metrics"}, "id": "system/metrics-system.fsstat-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"fsstat"}, "period": "1m", "processors": []interface{}{map[interface{}]interface{}{"drop_event.when.regexp": map[interface{}]interface{}{"system.fsstat.mount_point": "^/(sys|cgroup|proc|dev|etc|host|lib|snap)($|/)"}}}}, map[interface{}]interface{}{"condition": "${host.platform} != 'windows'", "data_stream": map[interface{}]interface{}{"dataset": "system.load", "type": "metrics"}, "id": "system/metrics-system.load-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"load"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.memory", "type": "metrics"}, "id": "system/metrics-system.memory-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"memory"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.network", "type": "metrics"}, "id": "system/metrics-system.network-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"network"}, "network.interfaces": interface{}(nil), "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.process", "type": "metrics"}, "id": "system/metrics-system.process-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"process"}, "period": "10s", "process.cgroups.enabled": false, "process.cmdline.cache.enabled": true, "process.include_cpu_ticks": false, "process.include_top_n.by_cpu": 5, "process.include_top_n.by_memory": 5, "processes": []interface{}{".*"}}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.process.summary", "type": "metrics"}, "id": "system/metrics-system.process.summary-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"process_summary"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.socket_summary", "type": "metrics"}, "id": "system/metrics-system.socket_summary-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"socket_summary"}, "period": "10s"}, map[interface{}]interface{}{"data_stream": map[interface{}]interface{}{"dataset": "system.uptime", "type": "metrics"}, "id": "system/metrics-system.uptime-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"uptime"}, "period": "10s"}}, "type": "system/metrics", "use_output": "default"}}, "output_permissions": map[interface{}]interface{}{"default": map[interface{}]interface{}{"2d61b712-b932-4a74-b9c3-aa6f4d6ad81c": map[interface{}]interface{}{"indices": []interface{}{map[interface{}]interface{}{"names": []interface{}{"logs-system.auth-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-system.syslog-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-system.application-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-system.security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-system.system-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.cpu-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.diskio-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.filesystem-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.fsstat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.load-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.memory-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.network-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.process-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.process.summary-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.socket_summary-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-system.uptime-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}}}, "_elastic_agent_checks": map[interface{}]interface{}{"cluster": []interface{}{"monitor"}}, "_elastic_agent_monitoring": map[interface{}]interface{}{"indices": []interface{}{map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.apm_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.apm_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.auditbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.auditbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.cloudbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.cloudbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.elastic_agent-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.endpoint_security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.endpoint_security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.filebeat_input-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.filebeat_input-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.filebeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.filebeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.fleet_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.fleet_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.heartbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.heartbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.metricbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.metricbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.osquerybeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.osquerybeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"logs-elastic_agent.packetbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[interface{}]interface{}{"names": []interface{}{"metrics-elastic_agent.packetbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}}}}}, "outputs": map[interface{}]interface{}{"default": map[interface{}]interface{}{"api_key": "NL0SmIYBNTmufd5CFMMy:_D5AGvF7QfCHxW8pbuJUsA", "hosts": []interface{}{"https://8160f5c5987d48409ab820c19d5a22bd.us-west2.gcp.elastic-cloud.com:443"}, "type": "elasticsearch"}}, "revision": 2, "signed": map[interface{}]interface{}{"data": "eyJpZCI6IjRkN2Q4NGUwLWI0NmQtMTFlZC1iYTNhLTU3MDUyYmNjNDM3ZiIsImFnZW50Ijp7InByb3RlY3Rpb24iOnsiZW5hYmxlZCI6dHJ1ZSwidW5pbnN0YWxsX3Rva2VuX2hhc2giOiIiLCJzaWduaW5nX2tleSI6Ik1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWFoSGxLcURSZkFjT1puMERtUUJDN25ROE1TN0NCTmQ4VEF2QlJsWmwvTUlMWDBHVnN5elVtT2pvK2ljTXgrUXV2N1gvcVZGbE5qSGh1QklwKzcvQUdBPT0ifX19", "signature": "MEYCIQDR6dw6v3wrPM2qHyy16iwX0WP52YBlg1JhdOp9oiNPjQIhANrvmRF/tkQrBM/kjcYCtU36i225YwD2Y7usfMCFraWW"}}

	var want = map[string]interface{}{"agent": map[string]interface{}{"download": map[string]interface{}{"sourceURI": "https://artifacts.elastic.co/downloads/"}, "features": map[string]interface{}{}, "monitoring": map[string]interface{}{"enabled": true, "logs": true, "metrics": true, "namespace": "default", "use_output": "default"}, "protection": map[string]interface{}{"enabled": true, "signing_key": "MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEahHlKqDRfAcOZn0DmQBC7nQ8MS7CBNd8TAvBRlZl/MILX0GVsyzUmOjo+icMx+Quv7X/qVFlNjHhuBIp+7/AGA==", "uninstall_token_hash": ""}}, "fleet": map[string]interface{}{"hosts": []interface{}{"https://e68bf0a8e9c745f696dcbb808b6d7597.fleet.us-west2.gcp.elastic-cloud.com:443"}}, "id": "4d7d84e0-b46d-11ed-ba3a-57052bcc437f", "inputs": []interface{}{map[string]interface{}{"data_stream": map[string]interface{}{"namespace": "default"}, "id": "logfile-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[string]interface{}{"package": map[string]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.auth", "type": "logs"}, "exclude_files": []interface{}{".gz$"}, "id": "logfile-system.auth-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "multiline": map[string]interface{}{"match": "after", "pattern": "^\\s"}, "paths": []interface{}{"/var/log/auth.log*", "/var/log/secure*"}, "processors": []interface{}{map[string]interface{}{"add_locale": interface{}(nil)}}, "tags": []interface{}{"system-auth"}}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.syslog", "type": "logs"}, "exclude_files": []interface{}{".gz$"}, "id": "logfile-system.syslog-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "multiline": map[string]interface{}{"match": "after", "pattern": "^\\s"}, "paths": []interface{}{"/var/log/messages*", "/var/log/syslog*"}, "processors": []interface{}{map[string]interface{}{"add_locale": interface{}(nil)}}}}, "type": "logfile", "use_output": "default"}, map[string]interface{}{"data_stream": map[string]interface{}{"namespace": "default"}, "id": "winlog-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[string]interface{}{"package": map[string]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[string]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[string]interface{}{"dataset": "system.application", "type": "logs"}, "id": "winlog-system.application-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "Application"}, map[string]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[string]interface{}{"dataset": "system.security", "type": "logs"}, "id": "winlog-system.security-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "Security"}, map[string]interface{}{"condition": "${host.platform} == 'windows'", "data_stream": map[string]interface{}{"dataset": "system.system", "type": "logs"}, "id": "winlog-system.system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "ignore_older": "72h", "name": "System"}}, "type": "winlog", "use_output": "default"}, map[string]interface{}{"data_stream": map[string]interface{}{"namespace": "default"}, "id": "system/metrics-system-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "meta": map[string]interface{}{"package": map[string]interface{}{"name": "system", "version": "1.24.3"}}, "name": "system-2", "package_policy_id": "2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "revision": 2, "streams": []interface{}{map[string]interface{}{"cpu.metrics": []interface{}{"percentages", "normalized_percentages"}, "data_stream": map[string]interface{}{"dataset": "system.cpu", "type": "metrics"}, "id": "system/metrics-system.cpu-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"cpu"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.diskio", "type": "metrics"}, "diskio.include_devices": interface{}(nil), "id": "system/metrics-system.diskio-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"diskio"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.filesystem", "type": "metrics"}, "id": "system/metrics-system.filesystem-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"filesystem"}, "period": "1m", "processors": []interface{}{map[string]interface{}{"drop_event.when.regexp": map[string]interface{}{"system.filesystem.mount_point": "^/(sys|cgroup|proc|dev|etc|host|lib|snap)($|/)"}}}}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.fsstat", "type": "metrics"}, "id": "system/metrics-system.fsstat-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"fsstat"}, "period": "1m", "processors": []interface{}{map[string]interface{}{"drop_event.when.regexp": map[string]interface{}{"system.fsstat.mount_point": "^/(sys|cgroup|proc|dev|etc|host|lib|snap)($|/)"}}}}, map[string]interface{}{"condition": "${host.platform} != 'windows'", "data_stream": map[string]interface{}{"dataset": "system.load", "type": "metrics"}, "id": "system/metrics-system.load-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"load"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.memory", "type": "metrics"}, "id": "system/metrics-system.memory-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"memory"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.network", "type": "metrics"}, "id": "system/metrics-system.network-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"network"}, "network.interfaces": interface{}(nil), "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.process", "type": "metrics"}, "id": "system/metrics-system.process-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"process"}, "period": "10s", "process.cgroups.enabled": false, "process.cmdline.cache.enabled": true, "process.include_cpu_ticks": false, "process.include_top_n.by_cpu": 5, "process.include_top_n.by_memory": 5, "processes": []interface{}{".*"}}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.process.summary", "type": "metrics"}, "id": "system/metrics-system.process.summary-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"process_summary"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.socket_summary", "type": "metrics"}, "id": "system/metrics-system.socket_summary-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"socket_summary"}, "period": "10s"}, map[string]interface{}{"data_stream": map[string]interface{}{"dataset": "system.uptime", "type": "metrics"}, "id": "system/metrics-system.uptime-2d61b712-b932-4a74-b9c3-aa6f4d6ad81c", "metricsets": []interface{}{"uptime"}, "period": "10s"}}, "type": "system/metrics", "use_output": "default"}}, "output_permissions": map[string]interface{}{"default": map[string]interface{}{"2d61b712-b932-4a74-b9c3-aa6f4d6ad81c": map[string]interface{}{"indices": []interface{}{map[string]interface{}{"names": []interface{}{"logs-system.auth-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-system.syslog-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-system.application-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-system.security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-system.system-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.cpu-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.diskio-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.filesystem-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.fsstat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.load-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.memory-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.network-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.process-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.process.summary-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.socket_summary-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-system.uptime-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}}}, "_elastic_agent_checks": map[string]interface{}{"cluster": []interface{}{"monitor"}}, "_elastic_agent_monitoring": map[string]interface{}{"indices": []interface{}{map[string]interface{}{"names": []interface{}{"logs-elastic_agent.apm_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.apm_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.auditbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.auditbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.cloudbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.cloudbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.elastic_agent-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.endpoint_security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.endpoint_security-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.filebeat_input-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.filebeat_input-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.filebeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.filebeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.fleet_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.fleet_server-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.heartbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.heartbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.metricbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.metricbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.osquerybeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.osquerybeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"logs-elastic_agent.packetbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}, map[string]interface{}{"names": []interface{}{"metrics-elastic_agent.packetbeat-default"}, "privileges": []interface{}{"auto_configure", "create_doc"}}}}}}, "outputs": map[string]interface{}{"default": map[string]interface{}{"api_key": "NL0SmIYBNTmufd5CFMMy:_D5AGvF7QfCHxW8pbuJUsA", "hosts": []interface{}{"https://8160f5c5987d48409ab820c19d5a22bd.us-west2.gcp.elastic-cloud.com:443"}, "type": "elasticsearch"}}, "revision": 2, "signed": map[string]interface{}{"data": "eyJpZCI6IjRkN2Q4NGUwLWI0NmQtMTFlZC1iYTNhLTU3MDUyYmNjNDM3ZiIsImFnZW50Ijp7InByb3RlY3Rpb24iOnsiZW5hYmxlZCI6dHJ1ZSwidW5pbnN0YWxsX3Rva2VuX2hhc2giOiIiLCJzaWduaW5nX2tleSI6Ik1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWFoSGxLcURSZkFjT1puMERtUUJDN25ROE1TN0NCTmQ4VEF2QlJsWmwvTUlMWDBHVnN5elVtT2pvK2ljTXgrUXV2N1gvcVZGbE5qSGh1QklwKzcvQUdBPT0ifX19", "signature": "MEYCIQDR6dw6v3wrPM2qHyy16iwX0WP52YBlg1JhdOp9oiNPjQIhANrvmRF/tkQrBM/kjcYCtU36i225YwD2Y7usfMCFraWW"}}

	res := YAMLMapToJSONMap(policyMap)

	diff := cmp.Diff(want, res)
	if diff != "" {
		t.Fatal(diff)
	}
}

func TestFixMap(t *testing.T) {
	tests := []struct {
		name          string
		input, output map[string]interface{}
	}{
		{
			name: "nil",
		},
		{
			name:   "empty",
			input:  map[string]interface{}{},
			output: map[string]interface{}{},
		},
		{
			name: "string map",
			input: map[string]interface{}{
				"nested": map[string]interface{}{
					"foo": "bar",
					"id":  nil,
				},
			},
			output: map[string]interface{}{
				"nested": map[string]interface{}{
					"foo": "bar",
					"id":  nil,
				},
			},
		},
		{
			name: "interface map",
			input: map[string]interface{}{
				"nested": map[interface{}]interface{}{
					"foo": "bar",
					"id":  nil,
				},
			},
			output: map[string]interface{}{
				"nested": map[string]interface{}{
					"foo": "bar",
					"id":  nil,
				},
			},
		},
		{
			name: "interface array",
			input: map[string]interface{}{
				"nested": []interface{}{
					map[string]interface{}{
						"foo": false,
						"nested": map[interface{}]interface{}{
							"foo": "bar",
							"id":  nil,
						},
					},
					map[interface{}]interface{}{
						"bar": true,
					},
				},
			},
			output: map[string]interface{}{
				"nested": []interface{}{
					map[string]interface{}{
						"foo": false,
						"nested": map[string]interface{}{
							"foo": "bar",
							"id":  nil,
						},
					},
					map[string]interface{}{
						"bar": true,
					},
				},
			},
		},
	}

	for _, tc := range tests {
		t.Run(tc.name, func(t *testing.T) {
			output := YAMLMapToJSONMap(tc.input)
			diff := cmp.Diff(tc.output, output)
			if diff != "" {
				t.Fatal(diff)
			}
		})
	}
}
