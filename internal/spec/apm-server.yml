name: apm-server
inputs:
  - name: apm-server
    description: "APM Server"
    platforms:
      - linux/386
      - linux/amd64
      - linux/arm64
      - linux/ppc64le
      - darwin/amd64
      - darwin/arm64
      - windows/amd64
      - windows/arm64
    command:
      - args: [
          "-E", "management.enabled=true",
          "-E", "gc_percent=${APMSERVER_GOGC:100}"
        ]
    outputs:
      - elasticsearch
      - redis
      - kafka
      - logstash

# backward compatibility, remove with new inputs

exported_metrics: [
  "apm-server",
]
rules:
  - copy_to_list:
      item: fleet
      to: inputs
      on_conflict: noop
  - map:
      path: fleet
      rules:
        - remove_key:
            key: access_api_key
        - remove_key:
            key: reporting
        - remove_key:
            key: agent
  - fix_stream: {}
  - filter_values:
      selector: inputs
      key: type
      values:
        - apm
  - filter:
      selectors:
        - inputs
        - output
        - fleet
  - inject_headers: {}
when: length(${inputs}) > 0 and hasKey(${output}, 'elasticsearch', 'redis',
  'kafka', 'logstash')