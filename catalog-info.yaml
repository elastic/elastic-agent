# Declare a Backstage Component that represents your application.
---
# yaml-language-server: $schema=https://json.schemastore.org/catalog-info.json
apiVersion: backstage.io/v1alpha1
kind: Component
metadata:
  name: elastic-agent
  description: Elastic Agent - single, unified way to add monitoring for logs, metrics, and other types of data to a host.
  annotations:
    sonarcloud.io/project-key: elastic_elastic-agent

spec:
  type: tool
  owner: group:ingest-fp
  system: platform-ingest
  lifecycle: production

---
# yaml-language-server: $schema=https://gist.githubusercontent.com/elasticmachine/988b80dae436cafea07d9a4a460a011d/raw/e57ee3bed7a6f73077a3f55a38e76e40ec87a7cf/rre.schema.json
apiVersion: backstage.io/v1alpha1
kind: Resource
metadata:
  name: buildkite-pipeline-elastic-agent
  description: Buildkite pipeline for the Elastic Agent project
  links:
    - title: Pipeline
      url: https://buildkite.com/elastic/elastic-agent

spec:
  type: buildkite-pipeline
  owner: group:ingest-fp
  system: buildkite
  implementation:
    apiVersion: buildkite.elastic.dev/v1
    kind: Pipeline
    metadata:
      name: elastic-agent
      description: Buildkite pipeline for the Elastic Agent project
    spec:
      branch_configuration: "main 7.* 8.* v7.* v8.*"
      repository: elastic/elastic-agent
      pipeline_file: ".buildkite/pipeline.yml"
      provider_settings:
        build_pull_request_forks: false
        build_pull_requests: true # requires filter_enabled and filter_condition settings as below when used with buildkite-pr-bot
        build_tags: true
        filter_enabled: true
        filter_condition: >-
          build.pull_request.id == null || (build.creator.name == 'elasticmachine' && build.pull_request.id != null)
      cancel_intermediate_builds: true
      cancel_intermediate_builds_branch_filter: '!main !7.* !8.* !9.*'
      skip_intermediate_builds: true
      skip_intermediate_builds_branch_filter: '!main !7.* !8.* !9.*'
      env:
        ELASTIC_SLACK_NOTIFICATIONS_ENABLED: "true"
        SLACK_NOTIFICATIONS_CHANNEL: "#ingest-notifications"
        SLACK_NOTIFICATIONS_ALL_BRANCHES: "false"
        SLACK_NOTIFICATIONS_ON_SUCCESS: "false"
      teams:
        ingest-fp:
          access_level: MANAGE_BUILD_AND_READ
        everyone:
          access_level: READ_ONLY

---
# yaml-language-server: $schema=https://gist.githubusercontent.com/elasticmachine/988b80dae436cafea07d9a4a460a011d/raw/e57ee3bed7a6f73077a3f55a38e76e40ec87a7cf/rre.schema.json
apiVersion: backstage.io/v1alpha1
kind: Resource
metadata:
  name: buildkite-pipeline-elastic-agent-package
  description: Buildkite pipeline for packaging Elastic Agent package
  links:
    - title: Pipeline
      url: https://buildkite.com/elastic/elastic-agent

spec:
  type: buildkite-pipeline
  owner: group:ingest-fp
  system: buildkite
  implementation:
    apiVersion: buildkite.elastic.dev/v1
    kind: Pipeline
    metadata:
      name: elastic-agent-package
      description: Buildkite pipeline for packaging Elastic Agent package
    spec:
      repository: elastic/elastic-agent
      pipeline_file: ".buildkite/pipeline.elastic-agent-package.yml"
      provider_settings:
        build_pull_request_forks: false
        build_pull_requests: true # requires filter_enabled and filter_condition settings as below when used with buildkite-pr-bot
        publish_commit_status: false # do not update status of commits for this pipeline
        build_tags: false
        build_branches: false
        filter_enabled: true
        filter_condition: >-
          build.pull_request.id == null || (build.creator.name == 'elasticmachine' && build.pull_request.id != null)
      cancel_intermediate_builds: true
      cancel_intermediate_builds_branch_filter: '!main !7.* !8.* !9.*'
      skip_intermediate_builds: true
      skip_intermediate_builds_branch_filter: '!main !7.* !8.* !9.*'
      teams:
        ingest-fp:
          access_level: MANAGE_BUILD_AND_READ
        release-eng:
          access_level: BUILD_AND_READ
        endpoint-ci-admin:
          access_level: BUILD_AND_READ
        everyone:
          access_level: READ_ONLY

---
# yaml-language-server: $schema=https://gist.githubusercontent.com/elasticmachine/988b80dae436cafea07d9a4a460a011d/raw/e57ee3bed7a6f73077a3f55a38e76e40ec87a7cf/rre.schema.json
apiVersion: backstage.io/v1alpha1
kind: Resource
metadata:
  name: buildkite-elastic-agent-binary-dra
  description: Buildkite pipeline for packaging Elastic Agent core binary and publish it to DRA
  links:
    - title: Pipeline
      url: https://buildkite.com/elastic/elastic-agent-binary-dra

spec:
  type: buildkite-pipeline
  owner: group:ingest-fp
  system: buildkite
  implementation:
    apiVersion: buildkite.elastic.dev/v1
    kind: Pipeline
    metadata:
      name: elastic-agent-binary-dra
      description: Buildkite pipeline for packaging Elastic Agent core binary and publish it to DRA
    spec:
      branch_configuration: "main 7.* 8.* v7.* v8.*"
      pipeline_file: ".buildkite/pipeline.elastic-agent-binary-dra.yml"
      provider_settings:
        build_pull_request_forks: false
        build_pull_requests: true # requires filter_enabled and filter_condition settings as below when used with buildkite-pr-bot
        publish_commit_status: false # do not update status of commits for this pipeline
        build_tags: false
        build_branches: true # enable build for branches. This relies on the filter in .buildkite/pipeline.elastic-agent-binary-dra.yml
        filter_enabled: true
        filter_condition: >-
          build.pull_request.id == null || (build.creator.name == 'elasticmachine' && build.pull_request.id != null)
      repository: elastic/elastic-agent
      schedules:
        Daily main:
          branch: main
          cronline: "@daily"
          message: Builds daily `main` dra
      teams:
        ingest-fp:
          access_level: MANAGE_BUILD_AND_READ
        everyone:
          access_level: BUILD_AND_READ
---
# yaml-language-server: $schema=https://gist.githubusercontent.com/elasticmachine/988b80dae436cafea07d9a4a460a011d/raw/e57ee3bed7a6f73077a3f55a38e76e40ec87a7cf/rre.schema.json
apiVersion: backstage.io/v1alpha1
kind: Resource
metadata:
  name: buildkite-elastic-agent-gce-cleanup
  description: Clean up stale GCE instances
  links:
    - title: Pipeline
      url: https://buildkite.com/elastic/elastic-agent

spec:
  type: buildkite-pipeline
  owner: group:ingest-fp
  system: buildkite
  implementation:
    apiVersion: buildkite.elastic.dev/v1
    kind: Pipeline
    metadata:
      name: elastic-agent-gce-cleanup
      description: Pipeline file for cleaning up lingering GCE instances
    spec:
      pipeline_file: ".buildkite/pipeline.elastic-agent-gce-cleanup.yml"
      provider_settings:
        build_pull_request_forks: false
        build_pull_requests: false # requires filter_enabled and filter_condition settings as below when used with buildkite-pr-bot
        publish_commit_status: false # do not update status of commits for this pipeline
        build_tags: false
        build_branches: false
        filter_enabled: true
        filter_condition: >-
          build.pull_request.id == null || (build.creator.name == 'elasticmachine' && build.pull_request.id != null)
      repository: elastic/elastic-agent
      schedules:
        Every 4 hours:
          branch: main
          cronline: "0 0/4 * * *" # every 4th hour
          message: GCE cleanup
      teams:
        ingest-fp:
          access_level: MANAGE_BUILD_AND_READ
        everyone:
          access_level: BUILD_AND_READ
